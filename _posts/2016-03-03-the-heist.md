---
layout: post
category: graphics
title: Gaming with mapbox
tags: graphics maps
summary: Designing an online game with multiple users using the mapbox API
image: img/posts/distributed_rt.png
---

The idea for this project came when I was brainstorming new project ideas with a colleague.
We wanted to combine the power of Operational Transforms with mapbox's API. Ultimately however we had no need for Operational Transform.

### The Rules of the game

A robber has just robbed a bank and is driving towards his safe-house, while some cops who were in the vicinity have been alerted of his presence and must chase him down.

Each player is shown a map with his current location tagged by an icon and a path which shows where he is headed.
The robber is by default heading for his safe-house but the player can change his direction to evade the cops, who in turn are by default following the robber but also can change their routes if they desire.

The game ends if the thief reaches the safe-house or if a cop catches up with him.

### Server side

Keeping things simple a node.js server is used with socket.io to receive and broadcast messages. Socket.io makes sending messages from the client side as simple as saying:

```
socket.emit('cop_spawn_loc', cop_spawn_list)
```

With this message the client can send to the server a list containing the latitude and longitude of the points at which the cops shown be spawned.

The only state that the server holds is a queue. When the server receives an incoming request announcing that a new cop wants to join, the server dequeues a number and sends it to the client who uses it as an ID to identify the cop.
When a cop disconnects the server puts his ID back into the queue.


### Client side

In it's current state the server supports 4 cops. The first four users who log in become cops and the fifth user becomes the robber.

## The robber

His initial spawn location is hardcoded in midtown Manhattan.
Mapbox's Turf API allows users to find points which are within a certain radius from a given point. In order to do that one must first create a json object with the center coordinates like this:

```
var center_feature = {
        'type' : 'Features',
        "properties": {},
        'geometry' : {
            'type' : 'Point',
            'coordinates' : [pos.lng, pos.lat]
        },
        'properties' : {
            'name' : 'Thief Loc'
        }
    };
```

Then one needs to call the buffer function with the desired radius and the desired unit system:

```
var radial_points = turf.buffer(center_feature, radius, 'miles');
```

The returned list contains 33 points which are all within the radius of the center point and one point is chosen randomly as the position of the safe-house that the thief then navigates towards.

## The cops

Once the robber's destination has been set


### Motion Blur

This is achieved by raytracing the image, then moving the sphere slightly, raytracing it again and averaging the colors so obtained with the previous ones.

This is the result that looks closest to what the paper shows. However it looks like a vibrating body and doesn't say which direction the body is headed.

![Motion blur 1](/img/distributedRT/looks_closest_to_the_paper.png "looks closest to what was in the paper")

The sphere is made to slowdown to give the impression that it is heading to the right but the effect isn't quite right.

![Motion blur 1](/img/distributedRT/MB_with_slow_down.png "making it look like it's slowing down")

The results are given weights based on when they appear and averaged. This is closest to what I had in mind.

![Motion blur 1](/img/distributedRT/weighte_Iter=30_speed=0.2.png "closer to what I wanted")
